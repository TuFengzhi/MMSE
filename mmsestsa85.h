//
// Created by Tu Fengzhi on 2018/9/30.
//

#ifndef MMSE_MMSESTSA85_H
#define MMSE_MMSESTSA85_H

#include <math.h>
#include <string.h>
#include <complex.h>
#include "fft.h"
#include "debugtools.h"
#include "ifft.h"
#include "expint.h"

#define PI 3.14159265359
#define SAMPLE_RATE 16000
#define WINDOW_SIZE 512 // 0.032s ~ 32ms
#define HALF_WINDOW_SIZE 257
#define SHIFT_PERCERTAGE 0.625
#define SHIFT_SIZE 320 // 0.02s ~ 20ms
#define NIS 24         // NS=fix((IS*fs-W)/(SP*W) +1): Number of initial silence segments 0.5s

#define ALPHA 0.99F    // Used in smoothing xi (For Deciesion Derected method for estimation of A Priori SNR)
#define NOISE_LENGTH 9 // This is a smoothing factor for the noise updating

int MMSESTSA85(float *Signal, float *OutputSignal);
void ReadBuffer(float *Left, float *Right, int StepSize, float *Buffer, int BufferSize);
void WriteBuffer(float *Buffer, int BufferSize, float *Left, float *Right, int StepSize);

static float HammingWindows[512] = {0.0800000000000000F, 0.0800347728510922F, 0.0801390861471897F, 0.0803129241175504F, 0.0805562604802531F, 0.0808690584461713F, 0.0812512707245349F, 0.0817028395300804F, 0.0822236965917867F, 0.0828137631631972F, 0.0834729500343248F, 0.0842011575451392F, 0.0849982756006349F, 0.0858641836874751F, 0.0867987508922121F, 0.0878018359210796F, 0.0888732871213544F, 0.0900129425042841F, 0.0912206297695777F, 0.0924961663314552F, 0.0938393593462515F, 0.0952500057415723F, 0.0967278922469959F, 0.0982727954263158F, 0.0998844817113229F, 0.101562707437116F, 0.103307218878942F, 0.105117752290555F, 0.106994033944090F, 0.108935780171451F, 0.110942697407190F, 0.113014482232900F, 0.115150821423078F, 0.117351391992489F, 0.119615861244988F, 0.121943886823829F, 0.124335116763416F, 0.126789189542520F, 0.129305734138936F, 0.131884370085575F, 0.134524707527986F, 0.137226347283294F, 0.139988880900559F, 0.142811890722518F, 0.145694949948735F, 0.148637622700128F, 0.151639464084863F, 0.154700020265623F, 0.157818828528214F, 0.160995417351525F, 0.164229306478818F, 0.167520006990331F, 0.170867021377199F, 0.174269843616671F, 0.177727959248612F, 0.181240845453283F, 0.184807971130384F, 0.188428796979351F, 0.192102775580887F, 0.195829351479728F, 0.199607961268618F, 0.203438033673490F, 0.207318989639832F, 0.211250242420238F, 0.215231197663108F, 0.219261253502514F, 0.223339800649186F, 0.227466222482637F, 0.231639895144378F, 0.235860187632244F, 0.240126461895792F, 0.244438072932762F, 0.248794368886594F, 0.253194691144983F, 0.257638374439446F, 0.262124746945909F, 0.266653130386270F, 0.271222840130951F, 0.275833185302402F, 0.280483468879552F, 0.285172987803193F, 0.289901033082266F, 0.294666889901055F, 0.299469837727260F, 0.304309150420925F, 0.309184096344226F, 0.314093938472081F, 0.319037934503582F, 0.324015336974215F, 0.329025393368872F, 0.334067346235619F, 0.339140433300211F, 0.344243887581339F, 0.349376937506586F, 0.354538807029081F, 0.359728715744822F, 0.364945879010665F, 0.370189508062953F, 0.375458810136762F, 0.380752988585762F, 0.386071243002651F, 0.391412769340175F, 0.396776760032682F, 0.402162404118215F, 0.407568887361125F, 0.412995392375164F, 0.418441098747069F, 0.423905183160591F, 0.429386819520977F, 0.434885179079857F, 0.440399430560543F, 0.445928740283706F, 0.451472272293418F, 0.457029188483535F, 0.462598648724408F, 0.468179810989899F, 0.473771831484685F, 0.479373864771827F, 0.484985063900589F, 0.490604580534485F, 0.496231565079536F, 0.501865166812718F, 0.507504534010578F, 0.513148814078003F, 0.518797153677122F, 0.524448698856319F, 0.530102595179338F, 0.535757987854461F, 0.541414021863744F, 0.547069842092280F, 0.552724593457484F, 0.558377421038368F, 0.564027470204796F, 0.569673886746686F, 0.575315817003162F, 0.580952407991612F, 0.586582807536650F, 0.592206164398949F, 0.597821628403941F, 0.603428350570348F, 0.609025483238540F, 0.614612180198688F, 0.620187596818698F, 0.625750890171910F, 0.631301219164535F, 0.636837744662818F, 0.642359629619905F, 0.647866039202389F, 0.653356140916529F, 0.658829104734110F, 0.664284103217933F, 0.669720311646912F, 0.675136908140758F, 0.680533073784239F, 0.685907992750989F, 0.691260852426847F, 0.696590843532716F, 0.701897160246913F, 0.707179000326999F, 0.712435565231067F, 0.717666060238471F, 0.722869694569976F, 0.728045681507313F, 0.733193238512121F, 0.738311587344257F, 0.743399954179451F, 0.748457569726302F, 0.753483669342583F, 0.758477493150843F, 0.763438286153294F, 0.768365298345950F, 0.773257784832023F, 0.778115005934540F, 0.782936227308169F, 0.787720720050246F, 0.792467760810971F, 0.797176631902773F, 0.801846621408813F, 0.806477023290612F, 0.811067137494800F, 0.815616270058954F, 0.820123733216510F, 0.824588845500752F, 0.829010931847831F, 0.833389323698837F, 0.837723359100864F, 0.842012382807096F, 0.846255746375871F, 0.850452808268711F, 0.854602933947321F, 0.858705495969516F, 0.862759874084087F, 0.866765455324571F, 0.870721634101924F, 0.874627812296078F, 0.878483399346371F, 0.882287812340826F, 0.886040476104284F, 0.889740823285363F, 0.893388294442228F, 0.896982338127179F, 0.900522410970016F, 0.904007977760192F, 0.907438511527728F, 0.910813493622886F, 0.914132413794581F, 0.917394770267521F, 0.920600069818071F, 0.923747827848825F, 0.926837568461861F, 0.929868824530702F, 0.932841137770931F, 0.935754058809479F, 0.938607147252565F, 0.941399971752279F, 0.944132110071792F, 0.946803149149196F, 0.949412685159951F, 0.951960323577940F, 0.954445679235113F, 0.956868376379721F, 0.959228048733126F, 0.961524339545172F, 0.963756901648129F, 0.965925397509171F, 0.968029499281413F, 0.970068888853475F, 0.972043257897574F, 0.973952307916141F, 0.975795750286950F, 0.977573306306754F, 0.979284707233417F, 0.980929694326552F, 0.982508018886631F, 0.984019442292588F, 0.985463736037898F, 0.986840681765121F, 0.988150071298913F, 0.989391706677504F, 0.990565400182624F, 0.991670974367883F, 0.992708262085602F, 0.993677106512079F, 0.994577361171301F, 0.995408889957088F, 0.996171567153674F, 0.996865277454706F, 0.997489915980686F, 0.998045388294819F, 0.998531610417298F, 0.998948508837994F, 0.999296020527573F, 0.999574092947026F, 0.999782684055610F, 0.999921762317205F, 0.999991306705082F, 0.999991306705082F, 0.999921762317205F, 0.999782684055610F, 0.999574092947026F, 0.999296020527573F, 0.998948508837994F, 0.998531610417298F, 0.998045388294819F, 0.997489915980686F, 0.996865277454706F, 0.996171567153674F, 0.995408889957088F, 0.994577361171301F, 0.993677106512079F, 0.992708262085602F, 0.991670974367883F, 0.990565400182624F, 0.989391706677504F, 0.988150071298913F, 0.986840681765121F, 0.985463736037898F, 0.984019442292588F, 0.982508018886631F, 0.980929694326552F, 0.979284707233417F, 0.977573306306754F, 0.975795750286950F, 0.973952307916141F, 0.972043257897574F, 0.970068888853475F, 0.968029499281413F, 0.965925397509171F, 0.963756901648129F, 0.961524339545172F, 0.959228048733126F, 0.956868376379721F, 0.954445679235113F, 0.951960323577940F, 0.949412685159951F, 0.946803149149196F, 0.944132110071792F, 0.941399971752279F, 0.938607147252565F, 0.935754058809479F, 0.932841137770931F, 0.929868824530702F, 0.926837568461861F, 0.923747827848825F, 0.920600069818071F, 0.917394770267521F, 0.914132413794581F, 0.910813493622886F, 0.907438511527728F, 0.904007977760192F, 0.900522410970016F, 0.896982338127179F, 0.893388294442228F, 0.889740823285363F, 0.886040476104284F, 0.882287812340826F, 0.878483399346371F, 0.874627812296078F, 0.870721634101924F, 0.866765455324571F, 0.862759874084087F, 0.858705495969516F, 0.854602933947321F, 0.850452808268711F, 0.846255746375871F, 0.842012382807096F, 0.837723359100864F, 0.833389323698837F, 0.829010931847831F, 0.824588845500752F, 0.820123733216510F, 0.815616270058954F, 0.811067137494800F, 0.806477023290612F, 0.801846621408813F, 0.797176631902773F, 0.792467760810971F, 0.787720720050246F, 0.782936227308169F, 0.778115005934540F, 0.773257784832023F, 0.768365298345950F, 0.763438286153294F, 0.758477493150843F, 0.753483669342583F, 0.748457569726302F, 0.743399954179451F, 0.738311587344257F, 0.733193238512121F, 0.728045681507313F, 0.722869694569976F, 0.717666060238471F, 0.712435565231067F, 0.707179000326999F, 0.701897160246913F, 0.696590843532716F, 0.691260852426847F, 0.685907992750989F, 0.680533073784239F, 0.675136908140758F, 0.669720311646912F, 0.664284103217933F, 0.658829104734110F, 0.653356140916529F, 0.647866039202389F, 0.642359629619905F, 0.636837744662818F, 0.631301219164535F, 0.625750890171910F, 0.620187596818698F, 0.614612180198688F, 0.609025483238540F, 0.603428350570348F, 0.597821628403941F, 0.592206164398949F, 0.586582807536650F, 0.580952407991612F, 0.575315817003162F, 0.569673886746686F, 0.564027470204796F, 0.558377421038368F, 0.552724593457484F, 0.547069842092280F, 0.541414021863744F, 0.535757987854461F, 0.530102595179338F, 0.524448698856319F, 0.518797153677122F, 0.513148814078003F, 0.507504534010578F, 0.501865166812718F, 0.496231565079536F, 0.490604580534485F, 0.484985063900589F, 0.479373864771827F, 0.473771831484685F, 0.468179810989899F, 0.462598648724408F, 0.457029188483535F, 0.451472272293418F, 0.445928740283706F, 0.440399430560543F, 0.434885179079857F, 0.429386819520977F, 0.423905183160591F, 0.418441098747069F, 0.412995392375164F, 0.407568887361125F, 0.402162404118215F, 0.396776760032682F, 0.391412769340175F, 0.386071243002651F, 0.380752988585762F, 0.375458810136762F, 0.370189508062953F, 0.364945879010665F, 0.359728715744822F, 0.354538807029081F, 0.349376937506586F, 0.344243887581339F, 0.339140433300211F, 0.334067346235619F, 0.329025393368872F, 0.324015336974215F, 0.319037934503582F, 0.314093938472081F, 0.309184096344226F, 0.304309150420925F, 0.299469837727260F, 0.294666889901055F, 0.289901033082266F, 0.285172987803193F, 0.280483468879552F, 0.275833185302402F, 0.271222840130951F, 0.266653130386270F, 0.262124746945909F, 0.257638374439446F, 0.253194691144983F, 0.248794368886594F, 0.244438072932762F, 0.240126461895792F, 0.235860187632244F, 0.231639895144378F, 0.227466222482637F, 0.223339800649186F, 0.219261253502514F, 0.215231197663108F, 0.211250242420238F, 0.207318989639832F, 0.203438033673490F, 0.199607961268618F, 0.195829351479728F, 0.192102775580887F, 0.188428796979351F, 0.184807971130384F, 0.181240845453283F, 0.177727959248612F, 0.174269843616671F, 0.170867021377199F, 0.167520006990331F, 0.164229306478818F, 0.160995417351525F, 0.157818828528214F, 0.154700020265623F, 0.151639464084863F, 0.148637622700128F, 0.145694949948735F, 0.142811890722518F, 0.139988880900559F, 0.137226347283294F, 0.134524707527986F, 0.131884370085575F, 0.129305734138936F, 0.126789189542520F, 0.124335116763416F, 0.121943886823829F, 0.119615861244988F, 0.117351391992489F, 0.115150821423078F, 0.113014482232900F, 0.110942697407190F, 0.108935780171451F, 0.106994033944090F, 0.105117752290555F, 0.103307218878942F, 0.101562707437116F, 0.0998844817113229F, 0.0982727954263158F, 0.0967278922469959F, 0.0952500057415723F, 0.0938393593462515F, 0.0924961663314552F, 0.0912206297695777F, 0.0900129425042841F, 0.0888732871213544F, 0.0878018359210796F, 0.0867987508922121F, 0.0858641836874751F, 0.0849982756006349F, 0.0842011575451392F, 0.0834729500343248F, 0.0828137631631972F, 0.0822236965917867F, 0.0817028395300804F, 0.0812512707245349F, 0.0808690584461713F, 0.0805562604802531F, 0.0803129241175504F, 0.0801390861471897F, 0.0800347728510922F, 0.0800000000000000F};

#endif //MMSE_MMSESTSA85_H
